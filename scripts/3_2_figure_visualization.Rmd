---
title: "3_2_figure_visualization"
author: "Aspen Coyle"
date: "2024-10-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Figure Creation

This script creates figures for the final paper.

```{r libraries, message=FALSE, warning=FALSE}
# Add all required libraries here
list.of.packages <- c("tidyverse", "lubridate", "beepr", "maps", "sf", "ggmap", "leaflet", "ggthemes", "cowplot", "easystats", "ggpubr")
# Get names of all required packages that aren't installed
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[, "Package"])]
# Install all new packages
if(length(new.packages)) install.packages(new.packages)


# Load all required libraries
lapply(list.of.packages, FUN = function(X) {
  do.call("require", list(X))
})


```

# Figure 1: Map showing survey sites

```{r}
# Read in the pot data to get the locations
loc_dat <- read.csv(file = "../output/ADFG_SE_AK_pot_surveys/cleaned_data/pot_data_with_temperature.csv")

# Remove all except Project, Location, Latitude, and Longitude, rename columns to be easier
loc_dat <- loc_dat %>%
  select("Project", "Location", "Latitude.Decimal.Degrees", "Longitude.Decimal.Degrees") %>%
  rename(Latitude = Latitude.Decimal.Degrees, 
         Longitude = Longitude.Decimal.Degrees)

# We've got some weird latitudes and longitudes, let's fix
# Drop all latitudes under 50 and over 60
# Drop all longitudes over -130 and under -150
loc_dat <- loc_dat %>%
  dplyr::filter(Latitude > 50 & Latitude < 60) %>%
  dplyr::filter(Longitude > -150 & Longitude < -130)

# Average lat and long by location
loc_dat <- loc_dat %>%
  group_by(Location, Project) %>%
  summarise(avg_lat = mean(Latitude, na.rm = TRUE),
            avg_long = mean(Longitude, na.rm = TRUE))


# Use data to create a geometry column which has compatible coordinates
map_dat <- loc_dat %>% 
  as.data.frame %>% 
  sf::st_as_sf(coords = c(4, 3))

# Convert this to a file that has the coordinates of each site 
sites_sfc <- st_sfc(map_dat$geometry, crs = 4326)

# Test that it's working and looking good
plot(sites_sfc)

# Register Stadia Maps key
register_stadiamaps("bbdd148e-ddf4-4650-ac62-ec8dfed17f18", write = TRUE)

# Define the boundaries of our basemap
southeast <- get_stadiamap(
  bbox = c(left = -138, bottom = 56, right = -132, top = 59),
  zoom = 8,
  maptype = "stamen_terrain_background")

# Create map of southeast
se_map <- ggmap(southeast) +
  geom_point(data = loc_dat,
             aes(x = avg_long, 
                 y = avg_lat,
                 shape = Project),
             size = 2) +
  xlab ("Longitude") +
  ylab ("Latitude (Â°N)") +
  guides(shape = FALSE)

# Define boundaries of our Alaska map
alaska <- get_stadiamap(
  bbox = c(left = -180, bottom = 46, right = -120, top = 73),
  zoom = 5,
  maptype = "stamen_terrain_background")

# Create map of Alaska
ak_map <- ggmap(alaska) +
  theme_map() +
  geom_rect(
    xmin = -138,
    ymin = 56, 
    xmax = -132,
    ymax = 59,
    fill = NA,
    colour = "black",
    linewidth = 0.5) +
  theme(legend.position = "none")

# Put AK map on top of SE map, with border around AK map
full_map <- se_map %>%
  ggdraw () +
  draw_plot(ak_map,
            x = 0.141,
            y = 0.079,
            width = 0.45,
            height = 0.45)

# Save plot
ggsave(filename = "../paper/images/Fig1_survey_location_map.png")
```

### Figure 2: Coefficients of General Model

```{r, fig.height=5, fig.width=7}
# Set model filepath
model_filepath <- "../output/ADFG_SE_AK_pot_surveys/models/weighted_models/all_crabs/"

# Read in average model
avg_model <- readRDS(file = paste0(model_filepath, "avg_model.rds"))

# Get basic plot
plot(avg_model)

# Create table of coefficients
coef_tab <- summary(avg_model)$coefmat.full
coef_tab <- as.data.frame(coef_tab)

# Turn rownames into column
coef_tab <- rownames_to_column(coef_tab, var = "variable")

# Remove column header whitespace
colnames(coef_tab) <- str_remove_all(colnames(coef_tab), " ")

# Edit variable column to remove unneeded elements
coef_tab$variable <- coef_tab$variable %>%
  str_replace("^cond\\(", "")
coef_tab$variable <- coef_tab$variable %>%
  str_replace("s.", "")
coef_tab <- dplyr::rename(coef_tab, significant = `Pr(>|z|)`)

# Remove int row
coef_tab <- coef_tab[coef_tab$variable != "(Int))", ]


# Arrange by magnitude of estimated coefficient
coef_tab <- coef_tab %>%
  arrange(desc(abs(Estimate)))

# Change pval to y/n
coef_tab$significant[coef_tab$significant >= 0.05] <- "n"
coef_tab$significant[coef_tab$significant < 0.05] <- "y"

# Create graph. Start with basic image and sorting
coef_tab %>%
  ggplot(aes(x = Estimate, y = reorder(variable, abs(Estimate), decreasing = FALSE), 
             colour = significant)) +
  geom_point() + 
  geom_errorbar(aes(xmin = Estimate - AdjustedSE, 
                    xmax = Estimate + AdjustedSE),
                width = 0.3) +
  geom_vline(xintercept=0, linetype = "dotted") +

  #mess with labels and axes
  scale_y_discrete(labels = c("Latitude", "Leg Condition", "Temperature",
                              "Depth", "Carapace Width", "Sex",
                              "Shell Cond. (Cubic)", "Black Mat", "Shell Cond. (Quadratic)",
                              "Shell Cond. (Linear)")) +
  ylab("Predictor Variable") +
  xlab ("Estimated Coefficient") +

  # mess with theme and appearance
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_line(color = "grey",
                                          linewidth = 0.2,
                                          linetype = 2)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("darkgrey", "black")) +
  theme(legend.position = "none")


# Save plot
ggsave(filename = "../paper/images/Fig2_gen_model_coefficients.png")
```



### Figure 3a: Coefficients of Sex-Specific Models

Here, we'll build female-specific and male-specific model coefficient graphs in separate chunks, and then compile them into a single plot

```{r, fig.height=5, fig.width=8}
# Set model filepath
model_filepath <- "../output/ADFG_SE_AK_pot_surveys/models/weighted_models/fem_crabs/"

# Read in average model
avg_model <- readRDS(file = paste0(model_filepath, "avg_model.rds"))

# Get basic plot
plot(avg_model)

# Create table of coefficients
coef_tab <- summary(avg_model)$coefmat.full
coef_tab <- as.data.frame(coef_tab)

# Turn rownames into column
coef_tab <- rownames_to_column(coef_tab, var = "variable")

# Remove column header whitespace
colnames(coef_tab) <- str_remove_all(colnames(coef_tab), " ")

# Edit variable column to remove unneeded elements
coef_tab$variable <- coef_tab$variable %>%
  str_replace("^cond\\(", "")
coef_tab$variable <- coef_tab$variable %>%
  str_replace("s.", "")
coef_tab <- dplyr::rename(coef_tab, significant = `Pr(>|z|)`)

# Remove int row
coef_tab <- coef_tab[coef_tab$variable != "(Int))", ]

# Arrange by magnitude of estimated coefficient
coef_tab <- coef_tab %>%
  arrange(desc(abs(Estimate)))

# Change pval to y/n
coef_tab$significant[coef_tab$significant >= 0.05] <- "n"
coef_tab$significant[coef_tab$significant != "n"] <- "y"

# Create graph. Start with basic image and sorting
fem_mod <- coef_tab %>%
  ggplot(aes(x = Estimate, y = reorder(variable, abs(Estimate), decreasing = FALSE),
             colour = significant)) +
  geom_point() + 
  geom_errorbar(aes(xmin = Estimate - AdjustedSE, 
                    xmax = Estimate + AdjustedSE),
                width = 0.3) +
  geom_vline(xintercept=0, linetype = "dotted") +

  #mess with labels and axes
  scale_y_discrete(labels = c("Latitude", "Leg Condition", "Depth",
                              "Egg Dev. (Uneyed)", "Temperature", "Carapace Width",
                              "Egg Percent", "Black Mat", "Egg Dev. (Barren)", 
                              "Egg Dev. (Dead Eggs)", "Egg Dev. (Juvenile)", "Shell Cond. (Cubic)",
                              "Shell Cond. (Quadratic)", "Shell Cond. (Linear)")) +
  scale_x_continuous(limits = c(-5, 1.7)) +
  ylab("Predictor Variable") +
  xlab ("Estimated Coefficient") +
  
  # mess with theme and appearance
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_line(color = "grey",
                                          linewidth = 0.2,
                                          linetype = 2)) +
  scale_color_manual(values = c("darkgrey", "black")) +
  theme(legend.position = "none")

# Save plot
ggsave(filename = "../paper/images/Fig3a_female_model_coefficients.png")
```

### Figure 4: Coefficients of Male Model

```{r, fig.height = 5, fig.width = 8}
# Set model filepath
model_filepath <- "../output/ADFG_SE_AK_pot_surveys/models/weighted_models/male_crabs/"

# Read in average model
avg_model <- readRDS(file = paste0(model_filepath, "avg_model.rds"))

# Get basic plot
plot(avg_model)

# Create table of coefficients
coef_tab <- summary(avg_model)$coefmat.full
coef_tab <- as.data.frame(coef_tab)

# Turn rownames into column
coef_tab <- rownames_to_column(coef_tab, var = "variable")

# Remove column header whitespace
colnames(coef_tab) <- str_remove_all(colnames(coef_tab), " ")

# Edit variable column to remove unneeded elements
coef_tab$variable <- coef_tab$variable %>%
  str_replace("^cond\\(", "")
coef_tab$variable <- coef_tab$variable %>%
  str_replace("s.", "")
coef_tab <- dplyr::rename(coef_tab, significant = `Pr(>|z|)`)

# Remove int row
coef_tab <- coef_tab[coef_tab$variable != "(Int))", ]

# Arrange by magnitude of estimated coefficient
coef_tab <- coef_tab %>%
  arrange(desc(abs(Estimate)))

# Change pval to y/n
coef_tab$significant[coef_tab$significant >= 0.05] <- "n"
coef_tab$significant[coef_tab$significant != "n"] <- "y"

# Create graph. Start with basic image and sorting
male_mod <- coef_tab %>%
  ggplot(aes(x = Estimate, y = reorder(variable, abs(Estimate), decreasing = FALSE),
             colour = significant)) +
  geom_point() + 
  geom_errorbar(aes(xmin = Estimate - AdjustedSE, 
                    xmax = Estimate + AdjustedSE),
                width = 0.3) +
  geom_vline(xintercept=0, linetype = "dotted") +

  #mess with labels and axes
  scale_y_discrete(labels = c("Latitude", "Black Mat", "Temperature",
                              "Depth", "Leg Condition", "Carapace Width",
                              "Shell Cond. (Cubic)", "Maturity", "Shell Cond. (Quadratic)",
                              "Shell Cond. (Linear)")) +
  scale_x_continuous(limits = c(-5, 1.7)) +
  ylab("Predictor Variable") +
  xlab ("Estimated Coefficient") +
  
  # mess with theme and appearance
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.grid.major.y = element_line(color = "grey",
                                          linewidth = 0.2,
                                          linetype = 2)) +
  scale_color_manual(values = c("darkgrey", "black")) +
  theme(legend.position = "none")

# Save plot
ggsave(filename = "../paper/images/Fig3b_male_model_coefficients.png")
```

# Create a single figure uniting the female, and male mods

```{r, fig.height=9, fig.width = 10}
ggarrange(fem_mod + rremove("xlab"), 
          male_mod,
          labels = c("F", "M"),
          ncol = 1, nrow = 2,
          align = "h")

# Save plot
ggsave(filename = "../paper/images/Fig_3_sex_specific_models.png")
```

#### Graphing Raw Data

```{r}
# Read in data
crabdat <- read.csv(file = "../output/ADFG_SE_AK_pot_surveys/cleaned_data/crab_data/BCS_examined_crab_with_temperature.csv")

# Calculate means and standard errors
SC_means <- tapply(crabdat$Bitter, crabdat$Shell.Condition, FUN = mean)
SE_vals <- with(crabdat, tapply(Bitter, Shell.Condition, FUN = sd) / sqrt(table(crabdat$Shell.Condition)))

# Create new data table
SC_table <- data.frame(SC_means, SE_vals)
# Rename and reorder columns
SC_table <- SC_table %>%
  rename(bitter_mean = SC_means,
         SC = Var1, 
         std_error = Freq) %>%
  relocate(SC)

# Multiply values by 100 to get percentages
SC_table$bitter_mean = SC_table$bitter_mean * 100
SC_table$std_error = SC_table$std_error * 100

# Plot 
ggplot(SC_table) +
  geom_bar(aes(x = SC, y = bitter_mean), 
           stat = "identity", 
           fill = "grey")+
  geom_errorbar(aes(x = SC, 
                    ymin = bitter_mean - std_error, 
                    ymax = bitter_mean + std_error),
                width = 0.3) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()) +
  ylab("Percent of Crabs with BCS") +
  xlab("Shell Condition") +
  scale_x_discrete(labels = c("New", "Old", "Very Old", "Very Very Old"))
  
  
  





```


